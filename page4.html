<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Yappers per Project</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500&display=swap');

  body {
    margin: 0;
    padding: 0;
    font-family: 'Orbitron', sans-serif;
    background-color: #000;
    color: white;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    min-height: 100vh;
  }

  .leaderboard {
    margin-top: 40px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    width: 90%;
    max-width: 900px;
    padding: 20px;
    background: rgba(255,255,255,0.05);
    backdrop-filter: blur(6px);
  }

  h1 {
    text-align: center;
    font-size: 28px;
    margin-bottom: 20px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    color: #fff;
  }

  th, td {
    padding: 8px 10px;
    text-align: center;
    font-size: 13px;
    border-bottom: 1px solid rgba(255,255,255,0.15);
  }

  th {
    text-transform: uppercase;
    letter-spacing: 1px;
    font-size: 14px;
  }

  tr:hover { background: rgba(255,255,255,0.08); }

  .vote-box { 
    display: flex; 
    justify-content: center; 
    align-items: center; 
    gap: 5px; 
  }

  .arrow {
    cursor: pointer;
    user-select: none;
    font-size: 14px;
    padding: 2px 6px;
    border-radius: 4px;
    border: 1px solid white;
    transition: 0.2s;
  }

  .arrow:hover { background: white; color: black; }
  .arrow.disabled { opacity: 0.5; cursor: default; }

  #loading {
    text-align: center;
    margin-top: 100px;
    color: #aaa;
    font-size: 16px;
  }
</style>
</head>
<body>
<div class="leaderboard" id="leaderboard-container">
  <h1>Yappers Per Project</h1>
  <div id="loading">Loading leaderboard...</div>
  <table id="leaderboard" style="display:none;">
    <thead>
      <tr>
        <th>No.</th>
        <th>Project</th>
        <th>Yappers Count</th>
        <th>Rewards</th>
        <th>Category</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBc2r-7g7UYtGZBV_JNAfEG_7sYY7UBsC4",
  authDomain: "rezo-chat.firebaseapp.com",
  projectId: "rezo-chat",
  storageBucket: "rezo-chat.appspot.com",
  messagingSenderId: "300513819927",
  appId: "1:300513819927:web:2c5f6a7f411273e1880b52"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const projectsData = [
  { name: "Sentient", rewards: "Ask team", category: "AI" },
  { name: "idOS", rewards: "0.8% supply", category: "Security" },
  { name: "Brevis", rewards: "Unknown", category: "ZK" },
  { name: "Zama", rewards: "$53k + NFTs", category: "FHE" },
  { name: "Rainbow", rewards: "idk lil bro", category: "Wallet" }
];

let currentUser = null;

function renderTable(projects, userVotes) {
  const loading = document.getElementById("loading");
  const table = document.getElementById("leaderboard");
  const tbody = table.querySelector("tbody");
  loading.style.display = "none";
  table.style.display = "table";
  tbody.innerHTML = "";

  projects.sort((a, b) => b.count - a.count);

  projects.forEach((proj, index) => {
    const tr = document.createElement("tr");

    const tdNo = document.createElement("td"); tdNo.textContent = index + 1;
    const tdName = document.createElement("td"); tdName.textContent = proj.name;
    const tdCount = document.createElement("td");
    const voteBox = document.createElement("div"); voteBox.className = "vote-box";

    const up = document.createElement("span");
    up.className = "arrow up";
    up.textContent = "â–²";

    if (userVotes.includes(proj.name)) up.classList.add("disabled");

    up.addEventListener("click", async () => {
      if (!currentUser || userVotes.includes(proj.name)) return;
      const monthDoc = doc(db, "projects", "monthly");
      await updateDoc(monthDoc, { [proj.name]: increment(1) });

      const userDoc = doc(db, "votes", currentUser.uid);
      await updateDoc(userDoc, { projects: [...userVotes, proj.name] });

      userVotes.push(proj.name);
      up.classList.add("disabled");
      proj.count++;
      renderTable(projects, userVotes);
    });

    const count = document.createElement("span"); count.textContent = proj.count || 0;

    voteBox.appendChild(up);
    voteBox.appendChild(count);
    tdCount.appendChild(voteBox);

    const tdRewards = document.createElement("td"); tdRewards.textContent = proj.rewards;
    const tdCategory = document.createElement("td"); tdCategory.textContent = proj.category;

    tr.append(tdNo, tdName, tdCount, tdRewards, tdCategory);
    tbody.appendChild(tr);
  });
}

async function init() {
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = "index.html"; // redirect if not logged in
      return;
    }
    currentUser = user;

    const monthDocRef = doc(db, "projects", "monthly");
    const monthSnap = await getDoc(monthDocRef);
    if (!monthSnap.exists()) {
      const initObj = {};
      projectsData.forEach(p => initObj[p.name] = 0);
      await setDoc(monthDocRef, initObj);
    }

    const userDocRef = doc(db, "votes", user.uid);
    const userSnap = await getDoc(userDocRef);
    if (!userSnap.exists()) {
      await setDoc(userDocRef, { projects: [] });
    }
    const userVotes = userSnap.exists() ? userSnap.data().projects : [];

    const updatedSnap = await getDoc(monthDocRef);
    const projects = projectsData.map(p => ({
      ...p,
      count: updatedSnap.data()[p.name] || 0
    }));

    renderTable(projects, userVotes);
  });
}

init();
</script>
</body>
</html>
