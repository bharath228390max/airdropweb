<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Rezo Twitter Friends Feed</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@600&display=swap');

body {
  margin: 0;
  height: 100vh;
  background-color: #000;
  font-family: 'Orbitron', sans-serif;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  overflow: hidden;
  color: white;
}

/* Stars background */
.star {
  position: absolute;
  border-radius: 50%;
  background: white;
  opacity: 0.8;
  animation: floatStar linear infinite;
}
@keyframes floatStar {
  0% { transform: translateY(0px); }
  50% { transform: translateY(-600px); }
  100% { transform: translateY(0px); }
}

h1 {
  color: blue;
  margin-top: 20px;
  letter-spacing: 1px;
  display: inline-block;
}

#addFriendBtn {
  margin-left: 15px;
  padding: 8px 16px;
  font-size: 22px;
  background: blue;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
}

#addFriendBtn:hover {
  opacity: 0.8;
}

.main-box {
  width: 80%;
  height: 70vh;
  margin-top: 10px;
  border: 1px solid white;
  border-radius: 10px;
  background: rgba(255,255,255,0.02);
  backdrop-filter: blur(4px);
  box-shadow: 0 0 20px rgba(255,255,255,0.2), inset 0 0 40px rgba(255,255,255,0.05);
  overflow-y: auto;
  padding: 15px;
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.main-box::-webkit-scrollbar {
  width: 8px;
}
.main-box::-webkit-scrollbar-thumb {
  background: blue;
  border-radius: 10px;
}

.friend-bubble {
  display: flex;
  gap: 12px;
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.6);
  border-radius: 15px;
  padding: 12px 16px;
  box-shadow: 0 0 10px rgba(255,255,255,0.1);
  position: relative;
}

.friend-bubble img {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  border: 1px solid rgba(255,255,255,0.4);
}

.friend-content {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.friend-name {
  font-weight: bold;
  color: blue;
  font-size: 18px;
}

.friend-text {
  font-size: 15px;
  line-height: 1.4;
  color: white;
}

.replyBtn {
  position: absolute;
  right: 12px;
  top: 12px;
  padding: 4px 10px;
  font-size: 14px;
  border-radius: 5px;
  border: none;
  background: blue;
  color: white;
  cursor: pointer;
}

.replyBtn:hover {
  opacity: 0.8;
}

/* Add friend popup */
#popup {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(0,0,0,0.95);
  border-radius: 15px;
  border: 2px solid blue;
  padding: 20px 30px;
  display: none;
  flex-direction: column;
  gap: 15px;
  z-index: 100;
}

#popup input {
  padding: 10px 12px;
  font-size: 16px;
  border-radius: 8px;
  border: 1px solid blue;
  background: rgba(255,255,255,0.05);
  color: white;
}

#popup button {
  padding: 10px 16px;
  font-size: 16px;
  border-radius: 8px;
  border: none;
  background: blue;
  color: white;
  cursor: pointer;
}

#popup button:hover {
  opacity: 0.8;
}

#backPopupBtn {
  background: transparent;
  color: blue;
  border: 1px solid blue;
  margin-top: 5px;
}

/* Scrollbar inside popup input (optional) */
#popup::-webkit-scrollbar {
  width: 6px;
}
#popup::-webkit-scrollbar-thumb {
  background: blue;
}
</style>
</head>
<body>

<h1>Engage your friends</h1>
<button id="addFriendBtn">Add Friends +</button>

<div class="main-box" id="feedBox">
  <!-- Friend posts will appear here -->
</div>

<!-- Popup for adding friend -->
<div id="popup">
  <h3 style="color:blue;">Enter Friend's Twitter ID</h3>
  <input type="text" id="friendIdInput" placeholder="@username">
  <button id="popupAddBtn">OK</button>
  <button id="backPopupBtn">Back</button>
</div>

<!-- Stars -->
<script>
for(let i=0;i<50;i++){
  let star = document.createElement('div');
  star.className = 'star';
  star.style.width = `${Math.random()*3 + 2}px`;
  star.style.height = star.style.width;
  star.style.left = `${Math.random()*100}%`;
  star.style.top = `${Math.random()*100}%`;
  star.style.animationDuration = `${Math.random()*10 + 5}s`;
  document.body.appendChild(star);
}
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getFirestore, doc, getDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBc2r-7g7UYtGZBV_JNAfEG_7sYY7UBsC4",
  authDomain: "rezo-chat.firebaseapp.com",
  databaseURL: "https://rezo-chat-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "rezo-chat",
  storageBucket: "rezo-chat.firebasestorage.app",
  messagingSenderId: "300513819927",
  appId: "1:300513819927:web:2c5f6a7f411273e1880b52"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const feedBox = document.getElementById('feedBox');
const addFriendBtn = document.getElementById('addFriendBtn');
const popup = document.getElementById('popup');
const friendIdInput = document.getElementById('friendIdInput');
const popupAddBtn = document.getElementById('popupAddBtn');
const backPopupBtn = document.getElementById('backPopupBtn');

let currentUserId = null;

// Mock fetch latest tweet function (replace with real API in future)
async function fetchLatestTweet(username){
  // Simulate fetching latest original tweet
  return `This is the actual latest tweet from ${username}`;
}

// Check login
onAuthStateChanged(auth, async user=>{
  if(user){
    currentUserId = user.uid;
    await loadFriends();
  }else{
    alert("Not authorized"); 
    window.location.href="page2.html";
  }
});

async function loadFriends(){
  feedBox.innerHTML = '';
  const docRef = doc(db,"profiles",currentUserId);
  const docSnap = await getDoc(docRef);
  if(docSnap.exists()){
    const data = docSnap.data();
    if(data.friends && data.friends.length>0){
      data.friends.forEach(friend=>{
        createFriendBubble(friend);
      });
    }
  }
}

function createFriendBubble(friend){
  const bubble = document.createElement('div');
  bubble.className = 'friend-bubble';

  const img = document.createElement('img');
  img.src = friend.img || `https://via.placeholder.com/50/0000ff`;

  const content = document.createElement('div');
  content.className = 'friend-content';

  const name = document.createElement('div');
  name.className = 'friend-name';
  name.innerText = friend.name;

  const text = document.createElement('div');
  text.className = 'friend-text';
  text.innerText = friend.text;

  const reply = document.createElement('button');
  reply.className = 'replyBtn';
  reply.innerText = 'Reply';
  reply.onclick = ()=>{
    window.open(friend.link1,'_blank');
  };

  content.appendChild(name);
  content.appendChild(text);
  bubble.appendChild(img);
  bubble.appendChild(content);
  bubble.appendChild(reply);

  feedBox.appendChild(bubble);
}

// Show popup
addFriendBtn.addEventListener('click',()=>{
  popup.style.display = 'flex';
});

// Back button
backPopupBtn.addEventListener('click',()=>{
  popup.style.display = 'none';
  friendIdInput.value = '';
});

// Add friend
popupAddBtn.addEventListener('click',async()=>{
  const friendId = friendIdInput.value.trim();
  if(!friendId) return;

  const docRef = doc(db,"profiles",currentUserId);
  const docSnap = await getDoc(docRef);
  let friendsArray = [];
  if(docSnap.exists()){
    const data = docSnap.data();
    friendsArray = data.friends || [];
    if(friendsArray.some(f=>f.name === friendId)){
      alert("Friend already added");
      return;
    }
  }

  const tweetText = await fetchLatestTweet(friendId);
  const newFriend = {
    name: friendId,
    text: tweetText,
    img: `https://via.placeholder.com/50/${Math.floor(Math.random()*16777215).toString(16)}`,
    link1: `https://x.com/${friendId}`
  };

  friendsArray.push(newFriend);
  await updateDoc(docRef,{friends: friendsArray});
  createFriendBubble(newFriend);
  friendIdInput.value='';
  popup.style.display='none';
});
</script>

</body>
</html>
