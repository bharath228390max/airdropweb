<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Rezo Friends Feed</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@600&display=swap');

body {
  margin: 0; height: 100vh; background-color: #000;
  font-family: 'Orbitron', sans-serif; display: flex;
  flex-direction: column; align-items: center; justify-content: flex-start;
  overflow: hidden; color: white;
}

h1 {
  color: #1E90FF; /* blue text */
  margin-top: 20px; letter-spacing: 1px;
}

#addFriendBtn {
  margin-left: 15px; padding: 8px 20px;
  font-size: 20px; cursor: pointer; border-radius: 8px;
  border: 1px solid #1E90FF; background: transparent; color: #1E90FF;
}

.main-box {
  width: 80%; height: 70vh; margin-top: 10px;
  border: 1px solid white; border-radius: 10px;
  background: rgba(255,255,255,0.02); backdrop-filter: blur(4px);
  box-shadow: 0 0 20px rgba(255,255,255,0.2), inset 0 0 40px rgba(255,255,255,0.05);
  overflow-y: auto; padding: 15px; box-sizing: border-box;
  display: flex; flex-direction: column; gap: 15px;
}

.main-box::-webkit-scrollbar { width: 8px; }
.main-box::-webkit-scrollbar-thumb { background: #1E90FF; border-radius: 10px; }

.friend-bubble {
  display: flex; gap: 12px; background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.6); border-radius: 15px;
  padding: 12px 16px; box-shadow: 0 0 10px rgba(255,255,255,0.1);
  position: relative;
}

.friend-bubble img {
  width: 50px; height: 50px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.4);
}

.friend-content { display: flex; flex-direction: column; gap: 4px; }

.friend-name { font-weight: bold; color: #1E90FF; }

.friend-text { font-size: 15px; line-height: 1.4; color: white; }

.reply-btn {
  position: absolute; right: 10px; bottom: 10px;
  border: 1px solid #1E90FF; background: transparent; color: #1E90FF;
  padding: 6px 12px; border-radius: 6px; cursor: pointer;
}

/* Stars animation */
.star {
  position: absolute; width: 3px; height: 3px; background: white;
  border-radius: 50%; animation: floatStars 10s linear infinite;
}
@keyframes floatStars { 0% { transform: translateY(0) } 100% { transform: translateY(-800px) } }
</style>
</head>
<body>

<h1>Engage your friends</h1>
<button id="addFriendBtn">Add Friend +</button>

<div class="main-box" id="feedBox"></div>

<!-- Popup -->
<div id="friendPopup" style="display:none; position:absolute; top:50%; left:50%; transform:translate(-50%, -50%);
  background: rgba(0,0,0,0.9); border: 1px solid #1E90FF; padding:20px; border-radius:10px; color:white; z-index:10;">
  <label>Enter Twitter Username:</label>
  <input type="text" id="friendUsername" style="padding:6px; margin-top:10px; width:200px;"><br><br>
  <button id="confirmAddBtn" style="margin-right:10px;">OK</button>
  <button id="popupBackBtn">Back</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getAuth } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBc2r-7g7UYtGZBV_JNAfEG_7sYY7UBsC4",
  authDomain: "rezo-chat.firebaseapp.com",
  databaseURL: "https://rezo-chat-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "rezo-chat",
  storageBucket: "rezo-chat.firebasestorage.app",
  messagingSenderId: "300513819927",
  appId: "1:300513819927:web:2c5f6a7f411273e1880b52"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const feedBox = document.getElementById('feedBox');
const addBtn = document.getElementById('addFriendBtn');
const popup = document.getElementById('friendPopup');
const confirmBtn = document.getElementById('confirmAddBtn');
const backBtn = document.getElementById('popupBackBtn');
const usernameInput = document.getElementById('friendUsername');

let userId = auth.currentUser ? auth.currentUser.uid : "MoFCIFmemsNUFVyjB0qeL3PCGWj1"; // Replace with real auth UID

async function loadFriends(){
    const docRef = doc(db, 'profiles', userId);
    const docSnap = await getDoc(docRef);
    if(docSnap.exists()){
        feedBox.innerHTML = '';
        const friends = docSnap.data().friends || [];
        for(let f of friends){
            const bubble = document.createElement('div');
            bubble.className = 'friend-bubble';

            const img = document.createElement('img');
            img.src = f.img || 'https://via.placeholder.com/50';

            const content = document.createElement('div');
            content.className = 'friend-content';
            const name = document.createElement('div'); name.className = 'friend-name'; name.innerText = f.name;
            const text = document.createElement('div'); text.className = 'friend-text'; text.innerText = f.text;

            content.appendChild(name);
            content.appendChild(text);
            bubble.appendChild(img);
            bubble.appendChild(content);

            const reply = document.createElement('button'); reply.className = 'reply-btn'; reply.innerText = 'Reply';
            reply.onclick = () => window.open(f.link1 || "#", "_blank");
            bubble.appendChild(reply);

            feedBox.appendChild(bubble);
        }
    }
}

addBtn.onclick = () => popup.style.display = 'block';
backBtn.onclick = () => popup.style.display = 'none';

confirmBtn.onclick = async () => {
    const uname = usernameInput.value.trim();
    if(!uname) return alert("Enter username");

    // fetch latest tweet from your server
    let tweetText = "Loading...";
    try {
        const res = await fetch(`http://localhost:3000/latest-tweet/${uname}`);
        const data = await res.json();
        tweetText = data.tweet;
    } catch {
        tweetText = "Could not load tweet";
    }

    const docRef = doc(db, 'profiles', userId);
    const docSnap = await getDoc(docRef);
    let friendsArr = [];
    if(docSnap.exists()) friendsArr = docSnap.data().friends || [];

    if(friendsArr.find(f => f.name === uname)) return alert("Friend already added");

    const newFriend = { name: uname, text: tweetText, img: "https://via.placeholder.com/50" , link1:`https://x.com/${uname}`};
    await updateDoc(docRef, { friends: arrayUnion(newFriend) });
    usernameInput.value = '';
    popup.style.display = 'none';
    loadFriends();
}

loadFriends();
</script>
</body>
</html>
